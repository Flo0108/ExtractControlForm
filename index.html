<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Vienna AR Beams + Dust</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    body, html { margin:0; padding:0; overflow:hidden; }
    video#webcam {
      position: fixed; top:0; left:0;
      width: 100vw; height: 100vh;
      object-fit: cover;
      z-index: -1;
    }
    a-scene {
      position:absolute; top:0; left:0;
      width:100vw; height:100vh;
      background: transparent;
    }
  </style>
</head>
<body>
  <!-- Webcam background -->
  <video id="webcam" autoplay playsinline muted></video>

  <a-scene embedded renderer="alpha: true">
    <a-entity id="beams-container"></a-entity>
    <a-entity id="dust-container"></a-entity>
    <a-entity id="camera" camera look-controls="enabled:false"></a-entity>
  </a-scene>

  <script>
    // ------------------------------
    // 1️⃣ Webcam feed
    // ------------------------------
    const video = document.getElementById('webcam');
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => video.srcObject = stream)
      .catch(err => console.error('Camera error:', err));

    // ------------------------------
    // 2️⃣ GPS + compass
    // ------------------------------
    let userLocation = null;
    let compassHeading = 0;
    let smoothedAlpha = 0;
    const alphaSmoothing = 0.1;

    navigator.geolocation.watchPosition(pos => {
      userLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude };
    }, err => console.error('GPS error', err), { enableHighAccuracy:true });

    window.addEventListener('deviceorientationabsolute', e => {
      if(e.alpha !== null){
        smoothedAlpha = smoothedAlpha * (1 - alphaSmoothing) + e.alpha * alphaSmoothing;
        compassHeading = smoothedAlpha;
      }
    });

    // ------------------------------
    // 3️⃣ Vienna targets
    // ------------------------------
    const targets = [
      { lat: 48.2002, lon: 16.3525, color: 'cyan', name: 'Westbahnhof' },
      { lat: 48.1840, lon: 16.3330, color: 'yellow', name: 'Schönbrunn' },
      { lat: 48.1857, lon: 16.3128, color: 'magenta', name: 'Gloriette' },
      { lat: 48.2100, lon: 16.3700, color: 'lime', name: 'Stephansplatz' }
    ];

    const R = 6378137;
    const container = document.getElementById('beams-container');
    const beamObjects = [];

    function geoToENU(origin, target){
      const dLat = (target.lat - origin.lat) * Math.PI/180;
      const dLon = (target.lon - origin.lon) * Math.PI/180;
      const lat1 = origin.lat * Math.PI/180;
      const east = dLon * R * Math.cos(lat1);
      const north = dLat * R;
      return { east, north };
    }

    // ------------------------------
    // 4️⃣ Initialize beams
    // ------------------------------
    function initBeams(){
      targets.forEach((t, i) => {
        const beam = document.createElement('a-cylinder');
        beam.setAttribute('radius', '1');
        beam.setAttribute('height', '10');
        beam.setAttribute('color', t.color);
        beam.setAttribute('opacity', '0.7');
        beam.setAttribute('emissive', t.color);
        // initial position in front of camera
        beam.setAttribute('position', `${(i-1.5)*3} 5 -5`);
        container.appendChild(beam);
        beamObjects.push(beam);
      });
    }
    window.addEventListener('load', initBeams);

    // ------------------------------
    // 5️⃣ Initialize floating dust nodes
    // ------------------------------
    const dustContainer = document.getElementById('dust-container');
    const dustObjects = [];
    const NUM_DUST = 50;

    function initDust(){
      for(let i=0;i<NUM_DUST;i++){
        const dust = document.createElement('a-sphere');
        dust.setAttribute('radius', 0.1 + Math.random()*0.2);
        dust.setAttribute('color', 'white');
        dust.setAttribute('opacity', 0.5 + Math.random()*0.5);
        const x = (Math.random()-0.5)*10;
        const y = 1 + Math.random()*5;
        const z = -3 - Math.random()*5;
        dust.setAttribute('position', `${x} ${y} ${z}`);
        dustContainer.appendChild(dust);
        dustObjects.push({el:dust, basePos:{x,y,z}});
      }
    }
    window.addEventListener('load', initDust);

    // ------------------------------
    // 6️⃣ Update beams + dust
    // ------------------------------
    function updateScene(){
      // beams
      targets.forEach((t, i)=>{
        let posX = (i-1.5)*3;
        let posZ = -5;
        if(userLocation){
          const enu = geoToENU(userLocation, t);
          const headingRad = compassHeading * Math.PI/180;
          posX = (enu.east/50) * Math.cos(-headingRad) - (enu.north/50) * Math.sin(-headingRad);
          posZ = -((enu.east/50) * Math.sin(-headingRad) + (enu.north/50) * Math.cos(-headingRad));
        }
        const beam = beamObjects[i];
        const currentPos = beam.object3D.position;
        // simple jittered movement
        currentPos.x += (posX - currentPos.x) * 0.1;
        currentPos.z += (posZ - currentPos.z) * 0.1;
        currentPos.y = 5;
      });

      // floating dust
      dustObjects.forEach(d=>{
        // small random oscillation
        const p = d.el.object3D.position;
        p.x = d.basePos.x + (Math.random()-0.5)*0.05;
        p.y = d.basePos.y + (Math.random()-0.5)*0.05;
        p.z = d.basePos.z + (Math.random()-0.5)*0.05;
      });

      requestAnimationFrame(updateScene);
    }
    updateScene();
  </script>
</body>
</html>
