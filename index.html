<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Vienna AR Beams</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    body, html { margin:0; padding:0; overflow:hidden; }
    video#webcam {
      position: fixed; top:0; left:0;
      width: 100vw; height: 100vh;
      object-fit: cover;
      z-index: -1;
    }
    a-scene {
      position:absolute; top:0; left:0;
      width:100vw; height:100vh;
      background: transparent;
    }
  </style>
</head>
<body>
  <!-- Webcam background -->
  <video id="webcam" autoplay playsinline muted></video>

  <!-- 3D Scene -->
  <a-scene embedded renderer="alpha: true">
    <a-entity id="beams-container"></a-entity>
    <a-entity id="camera" camera look-controls="enabled:false"></a-entity>
  </a-scene>

  <script>
    // ------------------------------
    // 1️⃣ Webcam feed
    // ------------------------------
    const video = document.getElementById('webcam');
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => video.srcObject = stream)
      .catch(err => console.error('Camera error:', err));

    // ------------------------------
    // 2️⃣ User GPS & compass
    // ------------------------------
    let userLocation = null;
    let compassHeading = 0;
    let smoothedAlpha = 0;
    const alphaSmoothing = 0.1;

    navigator.geolocation.watchPosition(pos => {
      userLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude };
    }, err => console.error('GPS error', err), { enableHighAccuracy:true });

    window.addEventListener('deviceorientationabsolute', e => {
      if(e.alpha !== null){
        // low-pass smoothing
        smoothedAlpha = smoothedAlpha * (1 - alphaSmoothing) + e.alpha * alphaSmoothing;
        compassHeading = smoothedAlpha;
      }
    });

    // ------------------------------
    // 3️⃣ Targets across Vienna
    // ------------------------------
    const targets = [
      { lat: 48.2002, lon: 16.3525, color: 'cyan', name: 'Westbahnhof' },
      { lat: 48.2100, lon: 16.3700, color: 'magenta', name: 'Stephansplatz' },
      { lat: 48.1840, lon: 16.3330, color: 'yellow', name: 'Schönbrunn' },
      { lat: 48.2200, lon: 16.3600, color: 'lime', name: 'Prater' }
    ];

    const R = 6378137; // meters
    const container = document.getElementById('beams-container');

    function geoToENU(origin, target){
      const dLat = (target.lat - origin.lat) * Math.PI/180;
      const dLon = (target.lon - origin.lon) * Math.PI/180;
      const lat1 = origin.lat * Math.PI/180;
      const east = dLon * R * Math.cos(lat1);
      const north = dLat * R;
      return { east, north };
    }

    // ------------------------------
    // 4️⃣ Smooth interpolation
    // ------------------------------
    const beamObjects = [];

    function updateBeams(){
      if(container.children.length === 0){
        // initialize beams
        targets.forEach(t => {
          const beam = document.createElement('a-cylinder');
          beam.setAttribute('radius', '20');
          beam.setAttribute('height', '100');
          beam.setAttribute('color', t.color);
          beam.setAttribute('opacity', '0.7');
          beam.setAttribute('emissive', t.color);
          container.appendChild(beam);
          beamObjects.push(beam);
        });
      }

      targets.forEach((t, i) => {
        let posX = 0, posZ = -3; // default desktop position
        if(userLocation){
          const enu = geoToENU(userLocation, t);
          const headingRad = compassHeading * Math.PI / 180;
          posX = enu.east * Math.cos(-headingRad) - enu.north * Math.sin(-headingRad);
          posZ = -(enu.east * Math.sin(-headingRad) + enu.north * Math.cos(-headingRad));
        }

        // Smooth movement: interpolate current position
        const beam = beamObjects[i];
        const currentPos = beam.object3D.position;
        currentPos.x += (posX - currentPos.x) * 0.1;
        currentPos.z += (posZ - currentPos.z) * 0.1;
        currentPos.y = 5; // fixed height
      });
    }

    // ------------------------------
    // 5️⃣ Animation loop
    // ------------------------------
    function animate(){
      updateBeams();
      requestAnimationFrame(animate);
    }
    animate();
  </script>
</body>
</html>
